#! /usr/bin/env bash

[ ! -d .build ] && sudo bash -c "lb init -t 3 4" > init.err || make docker-init

make get-keys 1> /dev/null
make import-keys 1> /dev/null
make export-keys 1> /dev/null

if [ -f keyrings/repokeys.gpg ]; then
        gpg --no-default-keyring --keyring repokeys.gpg --import keyrings/repokeys.gpg
fi


export dsusekeyring="--keyring=$HOME/.gnupg/repokeys.gpg"

if [ "$nonfree" = "yes" ]; then
        export non_free='-nonfree'
        export nosource='--apt-source-archives false'
        export components='--components="main contrib non-free"'
        export archiveareas='--archive-areas "main,contrib,non-free"'
fi

if [ "$hardened" = "yes" ]; then
        export harden='-k grsec-amd64'
        export is_harden="-hardened"
fi

if [ -z "$proxy_addr" ]; then
        export useproxy="--apt-http-proxy $proxy_addr"
fi

if [ ! -z "$customize" ]; then
        export customized="-custom"
fi

if [ ! -z "$server" ]; then
        export serverdist="-server"
fi

if [ "$distro" = "debian" ]; then
        export mirror="$mirror_debian"
        export mirror_packages="$mirror_debian"
        export unstable="sid"
        export stable="sid"
        export bootstrapopts="--merged-usr $dsusekeyring --variant=minbase --include=gnupg2,gnutls-bin,apt-utils,ca-certificates,debian-archive-keyring --exclude=systemd,systemd-sysv $components"
        export usekeyring="--keyring-packages debian-archive-keyring"
elif [ "$distro" = "devuan" ]; then
        export mirror="$mirror_devuan"
        export mirror_packages="$mirror_devuan_devuan"
        #export unstable="ceres"
        export unstable="jessie"
        export stable="jessie"
        export bootstrapopts="--merged-usr $dsusekeyring --variant=minbase --include=busybox-syslogd,gnupg2,gnutls-bin,apt-utils,ca-certificates,devuan-keyring --exclude=systemd,systemd-sysv $components"
        export usekeyring="--keyring-packages devuan-keyring"
elif [ "$distro" = "ubuntu" ]; then
        export mirror="$mirror_ubuntu"
        export mirror_packages="$mirror_ubuntu"
        export unstable="artful"
        export stable="artful"
        export bootstrapopts="--merged-usr $dsusekeyring --include=gnupg2,apt-utils,apt-transport-https,ca-certificates --exclude=debian-archive-keyring $components"
        if [ ! -z "$nonfree" ]; then
                export components="--components=\"main,restricted,universe,multiverse\""
                export archiveareas="--archive-areas \"main,restricted,universe,multiverse\""
        fi
        export usekeyring="--keyring-packages ubuntu-archive-keyring"
        export distromode="--mode ubuntu"
fi

if [ ! -z "$components" ]; then
        echo "WARNING: USING NON-FREE COMPONENTS! $components"
        echo "$archiveareas"
fi
        echo "$mirror"
        echo "$mirror_packages"
        echo "$unstable"
        echo "$stable"
        echo "$bootstrapopts"
        echo "$usekeyring"
        echo "$distromode"
sleep 5

lb config noauto \
        --verbose \
        --debug \
        --force \
    --apt apt \
    --apt-recommends false \
    $useproxy \
    --binary-images iso-hybrid \
    --binary-filesystem ext4 \
    --cache true \
    --cache-indices true \
    --cache-packages true \
    --distribution "$unstable" \
    --parent-distribution "$stable" \
    --firmware-chroot false \
    --firmware-binary false \
    $usekeyring \
    --debootstrap-options "$bootstrapopts" \
    --initsystem sysvinit \
    $archiveareas \
    $nosource \
    $harden \
    --image-name "$image_prename$customized$hardened$serverdist$nonfree-$distro" \
    $distromode \
    --parent-mirror-bootstrap "$mirror" \
    --security false \
    --updates true #\
    #--system live #\
    #--parent-mirror-chroot "$mirror" \
    #--parent-mirror-chroot-security "$mirror" \
    #--parent-mirror-binary "$mirror" \
    #--parent-mirror-binary-security "$mirror" \
    #--parent-mirror-debian-installer "$parent_mirror" \
    #--mirror-bootstrap "$mirror" \
    #--mirror-chroot "$mirror" \
    #--mirror-chroot-security "$mirror" \
    #--mirror-binary "$mirror" \
    #--mirror-binary-security "$mirror" \
    #--parent-mirror-debian-installer "$parent_mirror"


make libre 1> /dev/null

if [ "$distro" = "devuan" ]; then
        make devuan-key 1> /dev/null
elif [ "$distro" = "ubuntu" ]; then
        make libre-ubuntu 1> /dev/null
fi

if [ "$hardened" = "yes" ]; then
        make permissive-user 1> /dev/null
else
        make easy-user 1> /dev/null
fi

if [ "$nonfree" = "yes" ]; then
        make unfree 1> /dev/null
        make nonfree-firmware 1> /dev/null
fi
if [ ! -z "$customize" ]; then
        make custom 1> /dev/null
fi

make skel 1> /dev/null
make packages 1> /dev/null

if [ ! -z "$server" ]; then
        make server-packages 1> /dev/null
fi

echo "$distro"
