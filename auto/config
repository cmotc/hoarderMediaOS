#! /usr/bin/env bash

set -e

make get-keys 1> /dev/null
make import-keys 1> /dev/null
make export-keys 1> /dev/null

if [ -f keyrings/repokeys.gpg ]; then
        gpg --no-default-keyring --keyring repokeys.gpg --import keyrings/repokeys.gpg
fi


if [ -f auto/common ]; then
        . auto/common
fi

export dsusekeyring="--keyring=$HOME/.gnupg/repokeys.gpg"

if [ "$nonfree" = "yes" ]; then
        export non_free='-nonfree'
        export nosource='--apt-source-archives false'
        export components='--components="main contrib non-free"'
        export archiveareas='--archive-areas "main,contrib,non-free"'
fi

if [ "$hardened" = "yes" ]; then
        export harden='-k grsec-amd64'
        export is_harden="-hardened"
fi

if [ "$customize" = "yes" ]; then
        export customized="-custom"
fi

if [ "$server" = "yes" ]; then
        export serverdist="-server"
fi

if [ ! -z "$proxy_addr" ]; then
        export useproxy="--apt-http-proxy $proxy_addr"
fi

if [ "$distro" = "debian" ]; then
        export mirror="$mirror_debian"
        export mirror_packages="$mirror_debian"
        export unstable="sid"
        export stable="sid"
        export bootstrapopts="--merged-usr $dsusekeyring --variant=minbase --include=gnupg2,dpkg,apt-utils,apt-transport-https,gnutls-bin,ca-certificates,debian-archive-keyring --exclude=systemd,systemd-sysv $components"
        export usekeyring="--keyring-packages debian-archive-keyring"
        export distromode="--mode debian"
elif [ "$distro" = "devuan" ]; then
        export mirror="$mirror_devuan"
        export mirror_packages="$mirror_devuan"
        #export unstable="ceres"
        #export stable="jessie"
        export unstable="jessie"
        export stable="ceres"
        export bootstrapopts="--merged-usr $dsusekeyring --variant=minbase --include=busybox-syslogd,gnupg2,dpkg,apt-transport-https,apt-utils,gnutls-bin,ca-certificates,devuan-keyring --exclude=systemd,systemd-sysv,sysv-rc $components"
        export usekeyring="--keyring-packages devuan-keyring"
        export distromode="--mode debian"
elif [ "$distro" = "ubuntu" ]; then
        export mirror="$mirror_ubuntu"
        export mirror_packages="$mirror_ubuntu"
        export unstable="artful"
        export stable="artful"
        export bootstrapopts="--merged-usr $dsusekeyring --include=gnupg2,apt-utils,apt-transport-https,ca-certificates --exclude=debian-archive-keyring $components"
        if [ ! -z "$nonfree" ]; then
                export components="--components=\"main,restricted,universe,multiverse\""
                export archiveareas="--archive-areas \"main,restricted,universe,multiverse\""
        fi
        export usekeyring="--keyring-packages ubuntu-archive-keyring"
        export distromode="--mode ubuntu"
fi

if [ ! -z "$components" ]; then
        echo "WARNING: USING NON-FREE COMPONENTS! $components"
        echo "$archiveareas"
fi

echo "#! /usr/bin/env bash" | tee auto/common
echo "# settings check:" | tee -a auto/common
echo "export mirror=\"$mirror\"" | tee -a auto/common
echo "export mirror_packages=\"$mirror_packages\"" | tee -a auto/common
echo "export unstable=\"$unstable\"" | tee -a auto/common
echo "export stable=\"$stable\"" | tee -a auto/common
echo "export bootstrapopts=\"$bootstrapopts\"" | tee -a auto/common
echo "export usekeyring=\"$usekeyring\"" | tee -a auto/common
echo "export distromode=\"$distromode\"" | tee -a auto/common
echo "export dsusekeyring=\"$dsusekeyring\"" | tee -a auto/common
echo "export nonfree=\"$nonfree\"" | tee -a auto/common
echo "export hardened=\"$hardened\"" | tee -a auto/common
echo "export proxy_addr=\"$proxy_addr\"" | tee -a auto/common
echo "export useproxy=\"$useproxy\"" | tee -a auto/common
echo "export customize=\"$customize\"" | tee -a auto/common
echo "export server=\"$server\"" | tee -a auto/common

lb config noauto \
        --force \
    --apt aptitude \
    --apt-recommends true \
    --apt-options "--assume-yes" \
    --bootloader syslinux \
    $useproxy \
    --binary-images hdd \
    --quiet \
    --cache true \
    --updates false \
    --security false \
    --cache-indices true \
    --cache-packages true \
    --distribution "$unstable" \
    --parent-distribution "$stable" \
    --firmware-chroot false \
    --firmware-binary false \
    $usekeyring \
    --debootstrap-options "$bootstrapopts" \
    --initsystem none \
    $archiveareas \
    $nosource \
    $harden \
    --image-name "$image_prename$customized$hardened$serverdist$nonfree-$distro" \
    $distromode \
    --parent-mirror-bootstrap "$mirror" \
    --parent-mirror-chroot "$mirror" \
    --parent-mirror-chroot-security "$mirror" \
    --parent-mirror-binary "$mirror" \
    --parent-mirror-binary-security "$mirror" \
    --parent-mirror-debian-installer "$mirror" \
    --mirror-bootstrap "$mirror" \
    --mirror-chroot "$mirror" \
    --mirror-chroot-security "$mirror" \
    --mirror-binary "$mirror" \
    --mirror-binary-security "$mirror" \
    --parent-mirror-debian-installer "$mirror" \
    --system live > >(tee -a config.log) 2> >(tee -a config.err >&2)


make libre 1> /dev/null

if [ "$distro" = "devuan" ]; then
        echo "creating devuan keyring" > >(tee -a config.log) 2> >(tee -a config.err >&2)
        make devuan-key 1> /dev/null
elif [ "$distro" = "ubuntu" ]; then
        echo "creating ubuntu keyring" > >(tee -a config.log) 2> >(tee -a config.err >&2)
        make libre-ubuntu 1> /dev/null
fi

if [ "$hardened" = "yes" ]; then
        echo "Creating user defaults" > >(tee -a config.log) 2> >(tee -a config.err >&2)
        make permissive-user 1> /dev/null
else
        echo "Creating user defaults" > >(tee -a config.log) 2> >(tee -a config.err >&2)
        make easy-user 1> /dev/null
fi

if [ "$nonfree" = "yes" ]; then
        echo "Adding nonfree repos" > >(tee -a config.log) 2> >(tee -a config.err >&2)
        make unfree 1> /dev/null
        make nonfree-firmware 1> /dev/null
fi
if [ "$customize" = "yes" ]; then
        echo "Creating customizations" > >(tee -a config.log) 2> >(tee -a config.err >&2)
        make custom 1> /dev/null
fi

make skel 1> /dev/null
make packages 1> /dev/null

if [ "$server" = "yes" ]; then
        echo "Setting up server distribution" > >(tee -a config.log) 2> >(tee -a config.err >&2)
        make server-packages 1> /dev/null
fi

echo "Done donfiguring $distro distro" > >(tee -a config.log) 2> >(tee -a config.err >&2)

find ./config -empty -delete
